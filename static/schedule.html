<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Appointment Schedule - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        
        .header-content {
            flex: 1;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 10px 14px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            min-width: 220px;
        }
        
        .user-info-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-icon {
            font-size: 20px;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .user-role {
            color: #666;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .user-location {
            color: #888;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #4CAF50;
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        h1 {
            color: #1a1a1a;
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .controls {
            background: white;
            padding: 15px 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-nav button {
            padding: 8px 16px;
            background: #0068c9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .date-nav button:hover {
            background: #0056a8;
        }
        
        .date-display {
            font-weight: bold;
            color: #1a1a1a;
            min-width: 200px;
            text-align: center;
        }
        
        .view-toggle {
            margin-left: auto;
        }
        
        .view-toggle button {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 14px;
        }
        
        .view-toggle button:first-child {
            border-radius: 6px 0 0 6px;
        }
        
        .view-toggle button:last-child {
            border-radius: 0 6px 6px 0;
        }
        
        .view-toggle button.active {
            background: #0068c9;
            color: white;
            border-color: #0068c9;
        }
        
        .calendar-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .calendar-grid {
            display: table;
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            position: relative;
            overflow: visible;
        }
        
        .calendar-header {
            display: table-row;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: visible;
        }
        
        .time-label-header,
        .provider-header {
            display: table-cell;
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border-right: 1px solid rgba(255,255,255,0.2);
            overflow: visible;
        }
        
        .time-label-header {
            width: 80px;
            background: #5a67d8;
        }
        
        .provider-header {
            min-width: 180px;
            font-size: 14px;
            cursor: help;
            position: relative;
            z-index: 1000;
            overflow: visible;
        }
        
        .provider-actions {
            display: block;
            margin-top: 6px;
        }
        
        .mark-unavailable-btn {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mark-unavailable-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .mark-unavailable-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .provider-header:hover {
            transform: scale(1.02);
            transition: transform 0.2s;
            z-index: 100000 !important;
        }
        
        .provider-specialty {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 3px;
        }
        
        .provider-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.3);
            z-index: 99999;
            min-width: 320px;
            max-width: 400px;
            text-align: left;
            color: #333;
            pointer-events: none;
        }
        
        .provider-header:hover .provider-tooltip {
            display: block;
        }
        
        .provider-tooltip::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid #667eea;
        }
        
        .provider-tooltip-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .provider-tooltip-section {
            margin-bottom: 10px;
        }
        
        .provider-tooltip-label {
            font-size: 11px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .provider-tooltip-value {
            font-size: 13px;
            color: #333;
            line-height: 1.5;
        }
        
        .provider-tooltip-specialties {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }
        
        .provider-specialty-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .provider-cert-list {
            list-style: none;
            padding: 0;
            margin: 4px 0 0 0;
        }
        
        .provider-cert-list li {
            font-size: 12px;
            color: #555;
            padding: 2px 0;
            padding-left: 16px;
            position: relative;
        }
        
        .provider-cert-list li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .calendar-row {
            display: table-row;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .calendar-row:hover {
            background: #f9f9f9;
        }
        
        .time-label,
        .appointment-cell {
            display: table-cell;
            padding: 10px;
            border-right: 1px solid #e0e0e0;
            vertical-align: top;
            min-height: 60px;
        }
        
        .time-label {
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            text-align: center;
            font-size: 12px;
            width: 80px;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        .appointment-cell {
            position: relative;
            min-width: 180px;
            background: white;
        }
        
        .appointment-block {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px;
            border-radius: 4px;
            margin: 2px 0;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        
        /* Status-based color coding */
        .appointment-block.pending_confirmation {
            background: #e1f5fe;
            border-color: #03a9f4;
        }
        
        .appointment-block.confirmed {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .appointment-block.rescheduled {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .appointment-block.reassigned {
            background: #fff9c4;
            border-color: #fdd835;
        }
        
        .appointment-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
        }
        
        .appointment-block:hover .tooltip {
            display: block;
        }
        
        .appointment-block.scheduled {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .appointment-block.completed {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .appointment-block.cancelled {
            background: #f8d7da;
            border-color: #dc3545;
            opacity: 0.7;
        }
        
        .appointment-block.needs-attention {
            background: #fff3cd;
            border-color: #ffc107;
            border-left-width: 6px;
            position: relative;
        }
        
        .attention-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ff9800;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
            animation: pulse-attention 2s infinite;
        }
        
        @keyframes pulse-attention {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .hod-badge {
            background: #ff6f00 !important;
            border: 2px solid #e65100;
            font-weight: 800;
            font-size: 11px;
            padding: 3px 8px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(255, 111, 0, 0.3);
        }
        
        .appointment-block.hod-review {
            background: #fff3e0 !important;
            border-left: 6px solid #ff6f00 !important;
        }
        
        /* Cancel Appointment Button - Clean X Icon */
        .cancel-appointment-btn {
            display: none;
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 200;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cancel-appointment-btn:hover {
            background: rgba(200, 35, 51, 1);
            transform: scale(1.15);
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.4);
        }
        
        .appointment-block:hover .cancel-appointment-btn {
            display: flex;
        }
        
        /* Audit Log Modal */
        .audit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999999;
            justify-content: center;
            align-items: center;
        }
        
        .audit-modal.show {
            display: flex;
        }
        
        .audit-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .audit-header {
            font-size: 20px;
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .audit-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .audit-section {
            margin: 16px 0;
            padding: 16px;
            background: #f8f9fa;
            border-left: 4px solid #2196f3;
            border-radius: 6px;
        }
        
        .audit-section-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .audit-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .audit-item:last-child {
            border-bottom: none;
        }
        
        .audit-label {
            font-weight: 600;
            color: #666;
            font-size: 12px;
        }
        
        .audit-value {
            color: #333;
            font-size: 13px;
            margin-left: 8px;
        }
        
        .scoring-details {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .scoring-factor {
            font-size: 12px;
            color: #2e7d32;
            line-height: 1.8;
        }
        
        .appointment-time {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .appointment-patient {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 3px;
        }
        
        .appointment-condition {
            font-size: 11px;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: bold;
            color: white;
            margin-top: 4px;
        }
        
        .status-badge.scheduled { background: #28a745; }
        .status-badge.completed { background: #17a2b8; }
        .status-badge.cancelled { background: #dc3545; }
        .status-badge.confirmed { background: #4caf50; color: white; }
        .status-badge.rescheduled { background: #ff9800; color: white; }
        .status-badge.pending { background: #03a9f4; color: white; }
        .status-badge.needs_attention { background: #ffc107; color: #333; }
        
        .tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 9999999 !important;
            min-width: 280px;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .tooltip-header {
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #333;
        }
        
        .tooltip-label {
            color: #666;
            font-weight: 600;
        }
        
        .tooltip-value {
            color: #1a1a1a;
        }
        
        .empty-slot {
            color: #ccc;
            font-size: 11px;
            text-align: center;
            padding: 20px 10px;
        }
        
        .unavailable-slot {
            background: #ffe0e0;
            border: 1px solid #ffcccc;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            color: #dc3545;
            font-size: 12px;
            font-weight: 600;
        }
        
        .provider-header.unavailable {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            opacity: 0.9;
        }
        
        .provider-unavailable-badge {
            display: inline-block;
            background: #fff;
            color: #dc3545;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .footer {
            margin-top: 20px;
            padding: 20px;
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary { background: #0068c9; color: white; }
        .btn-secondary { background: #ff4b4b; color: white; }
        .btn-success { background: #28a745; color: white; }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-size: 16px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0068c9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .legend {
            display: flex;
            gap: 20px;
            padding: 15px 30px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border-left: 4px solid;
        }
        
        /* Waitlist Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #e74c3c;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .waitlist-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .priority-high { color: #e74c3c; }
        .priority-medium { color: #f39c12; }
        .priority-low { color: #95a5a6; }
        
        .waitlist-card {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .waitlist-card:hover {
            background: #ecf0f1;
            transform: translateX(5px);
        }
        
        .waitlist-card.high { border-left-color: #e74c3c; }
        .waitlist-card.medium { border-left-color: #f39c12; }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .patient-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .patient-id {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .detail-item {
            color: #555;
        }
        
        .detail-label {
            font-weight: 500;
            color: #7f8c8d;
        }
        
        .card-notes {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-top: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .badge {
            background: white;
            color: #f39c12;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .freed-slot-card {
            background: #e8f8f5;
            border-left: 4px solid #27ae60;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        
        .slot-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .slot-details {
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üìÖ Appointment Schedule</h1>
                <p class="subtitle">Calendar Grid View ‚Ä¢ Real-time updates ‚Ä¢ WebPT-style layout</p>
            </div>
            <div class="user-info">
                <div class="user-info-content">
                    <div class="user-icon">üë§</div>
                    <div class="user-details">
                        <div class="user-name">Jessica</div>
                        <div class="user-role">Receptionist</div>
                        <div class="user-location">üìç Renew Physical Therapy</div>
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            Logged in
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #e8f5e9; border-color: #4caf50;"></div>
                <span>üü¢ Confirmed</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e1f5fe; border-color: #03a9f4;"></div>
                <span>üîµ Pending Confirmation</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3e0; border-color: #ff6f00; border-left-width: 4px;"></div>
                <span>üü† HOD Review (Low Match Score)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f8d7da; border-color: #dc3545;"></div>
                <span>üî¥ Cancelled</span>
            </div>
        </div>

        <div id="attention-banner" style="display:none; background:#fff3e0; border-left:4px solid #ff6f00; padding:12px 20px; margin-bottom:15px; border-radius:8px;">
            <strong style="color:#e65100;">‚ö†Ô∏è HOD Manual Review Required:</strong>
            <span id="attention-message" style="color:#e65100; margin-left:8px;"></span>
        </div>
        
        <div id="audit-log-banner" style="display:none; background:#e3f2fd; border-left:4px solid #2196f3; padding:12px 20px; margin-bottom:15px; border-radius:8px;">
            <strong style="color:#1565c0;">üìã Recent Reassignment:</strong>
            <span id="audit-message" style="color:#1565c0; margin-left:8px;"></span>
            <button onclick="showAuditLog()" style="margin-left:12px; background:#2196f3; color:white; border:none; padding:4px 12px; border-radius:4px; cursor:pointer; font-size:12px;">
                View Details ‚Üí
            </button>
        </div>
        
        <div class="controls">
            <div class="date-nav">
                <button onclick="previousDay()">‚óÄ Previous</button>
                <div class="date-display" id="date-display">Today</div>
                <button onclick="nextDay()">Next ‚ñ∂</button>
                <button onclick="goToToday()">üìÖ Today</button>
                <button onclick="openWaitlistModal()" style="background: #f39c12; margin-left: 10px;">
                    ‚è≥ Waitlist <span id="waitlist-badge" class="badge" style="display: none;">0</span>
                </button>
            </div>
            <div class="view-toggle">
                <button class="active" onclick="setView('day')">Day View</button>
                <button onclick="setView('week')">Week View</button>
            </div>
        </div>

        <div class="calendar-wrapper">
            <div id="calendar-content" class="loading">
                <div class="loading-spinner"></div>
                Loading schedule...
            </div>
        </div>
        
        <!-- Audit Log Modal -->
        <div id="audit-modal" class="audit-modal" onclick="if(event.target===this) hideAuditLog()">
            <div class="audit-modal-content">
                <div class="audit-header">
                    üìã Reassignment Audit Log
                    <button class="audit-close" onclick="hideAuditLog()">‚úï Close</button>
                </div>
                <div id="audit-log-content">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Unavailable Modal -->
        <div id="unavailable-modal" class="audit-modal" onclick="if(event.target===this) hideUnavailableModal()">
            <div class="audit-modal-content" style="max-width: 550px;">
                <div class="audit-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    üö´ Mark Provider Unavailable
                    <button class="audit-close" onclick="hideUnavailableModal()">‚úï</button>
                </div>
                <div style="padding: 30px;">
                    <div style="margin-bottom: 25px;">
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">
                            üë®‚Äç‚öïÔ∏è <span id="modal-provider-name"></span>
                        </div>
                        <div style="font-size: 13px; color: #7f8c8d;">
                            Mark this provider as unavailable for specific date(s)
                        </div>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #34495e;">
                            üìã Reason:
                        </label>
                        <select id="unavailable-reason" style="width: 100%; padding: 10px; border: 2px solid #ecf0f1; border-radius: 6px; font-size: 14px;">
                            <option value="sick">ü§í Sick</option>
                            <option value="vacation">üèñÔ∏è Vacation</option>
                            <option value="medical_leave">üè• Medical Leave</option>
                            <option value="personal">üë§ Personal Leave</option>
                            <option value="other">üìù Other</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #34495e;">
                            üìÖ Duration:
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="duration-type" value="today" checked style="margin-right: 10px; width: 18px; height: 18px;">
                                <span style="font-weight: 500;">Today only</span>
                                <span style="margin-left: auto; color: #7f8c8d; font-size: 13px;" id="today-label"></span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="duration-type" value="tomorrow" style="margin-right: 10px; width: 18px; height: 18px;">
                                <span style="font-weight: 500;">Today + Tomorrow</span>
                                <span style="margin-left: auto; color: #7f8c8d; font-size: 13px;" id="tomorrow-label"></span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="duration-type" value="3days" style="margin-right: 10px; width: 18px; height: 18px;">
                                <span style="font-weight: 500;">Next 3 days</span>
                                <span style="margin-left: auto; color: #7f8c8d; font-size: 13px;" id="3days-label"></span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="duration-type" value="custom" style="margin-right: 10px; width: 18px; height: 18px;">
                                <span style="font-weight: 500;">Custom range</span>
                            </label>
                            <div id="custom-date-range" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 6px; margin-top: 5px;">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="date" id="custom-start-date" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 4px;">
                                    <span style="color: #7f8c8d;">to</span>
                                    <input type="date" id="custom-end-date" style="flex: 1; padding: 8px; border: 2px solid #ecf0f1; border-radius: 4px;">
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; padding: 12px; border: 2px solid #ecf0f1; border-radius: 6px; background: white; cursor: not-allowed; opacity: 0.9;">
                                <div style="margin-right: 10px; width: 18px; height: 18px; border: 2px solid #bdc3c7; border-radius: 50%;"></div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #34495e;">üëã Provider has left the organization</div>
                                    <div style="color: #7f8c8d; font-size: 12px; margin-top: 2px;">All future appointments will be automatically rescheduled</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; margin-bottom: 25px;">
                        <div style="font-size: 13px; color: #856404; line-height: 1.6;">
                            <strong>‚ö†Ô∏è This will:</strong><br>
                            ‚Ä¢ Mark provider unavailable for selected date(s)<br>
                            ‚Ä¢ Find all affected appointments<br>
                            ‚Ä¢ Reassign patients automatically<br>
                            ‚Ä¢ Send ONE email per patient (grouped by patient)<br>
                            ‚Ä¢ Update calendar in real-time
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="hideUnavailableModal()" style="padding: 12px 24px; background: #95a5a6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            Cancel
                        </button>
                        <button onclick="confirmMarkUnavailable(window.selectedProviderId, window.selectedProviderName)" style="padding: 12px 24px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                            üö´ Mark Unavailable
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <a href="/" target="_blank" class="btn btn-primary">üè† Back to Home</a>
            <a href="/emails.html" target="_blank" class="btn btn-secondary">üìß View Emails</a>
            <button onclick="loadSchedule()" class="btn btn-success">üîÑ Refresh</button>
        </div>
    </div>

    <script>
        // Get base URL dynamically - works for any host/port
        const getBaseUrl = () => {
            return `${window.location.protocol}//${window.location.host}`;
        };

        let currentDate = new Date();
        let currentView = 'day';
        let appointments = [];
        let providers = [];
        let patients = {};
        let providerAvailability = {}; // Track provider unavailability

        // Time slots (8 AM to 7 PM in 30-minute intervals)
        const timeSlots = [
            '08:00', '08:30', '09:00', '09:30', '10:00', '10:30',
            '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
            '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
            '17:00', '17:30', '18:00', '18:30', '19:00'
        ];

        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        function formatDate(date) {
            // Use local date instead of UTC to avoid timezone issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        console.log('üóìÔ∏è Calendar initialized with date:', currentDate, '‚Üí Formatted:', formatDate(currentDate));

        function formatDateDisplay(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function previousDay() {
            currentDate.setDate(currentDate.getDate() - 1);
            updateDateDisplay();
            calculateProviderAvailability();
            renderCalendar();
        }

        function nextDay() {
            currentDate.setDate(currentDate.getDate() + 1);
            updateDateDisplay();
            calculateProviderAvailability();
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            updateDateDisplay();
            calculateProviderAvailability();
            renderCalendar();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderCalendar();
        }

        function updateDateDisplay() {
            document.getElementById('date-display').textContent = formatDateDisplay(currentDate);
        }

        async function loadData() {
            try {
                const baseUrl = getBaseUrl();
                const [aptsRes, provsRes, patsRes] = await Promise.all([
                    fetch(`${baseUrl}/api/appointments`),
                    fetch(`${baseUrl}/api/providers`),
                    fetch(`${baseUrl}/api/patients`)
                ]);

                appointments = await aptsRes.json();
                providers = await provsRes.json();
                const patientsArray = await patsRes.json();
                
                // Store globally for audit log
                window.patientsData = patientsArray;
                window.providersData = providers;
                
                console.log('üìä Data loaded:');
                console.log('  - Appointments:', appointments.length, appointments);
                console.log('  - Providers:', providers.length);
                console.log('  - Patients:', patientsArray.length);
                
                // Create patient lookup
                patients = {};
                patientsArray.forEach(p => {
                    patients[p.patient_id] = p;
                });

                // Calculate provider availability for the selected date
                calculateProviderAvailability();

                renderCalendar();
            } catch (error) {
                document.getElementById('calendar-content').innerHTML = `
                    <div class="loading">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <div>Error loading schedule</div>
                        <p style="color: #999; font-size: 14px; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function calculateProviderAvailability() {
            // Check which providers are marked as unavailable on the selected date
            const dateStr = formatDate(currentDate);
            const dayOfWeek = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            
            providerAvailability = {};
            
            providers.forEach(provider => {
                // Check 1: Status field (sick, on_leave, unavailable, left_organization)
                if (provider.status && ['sick', 'on_leave', 'unavailable', 'left_organization'].includes(provider.status)) {
                    providerAvailability[provider.provider_id] = 'unavailable';
                    return;
                }
                
                // Check 2: Available days (e.g., doesn't work on weekends)
                if (provider.available_days && provider.available_days.length > 0) {
                    if (!provider.available_days.includes(dayOfWeek)) {
                        providerAvailability[provider.provider_id] = 'unavailable';
                        return;
                    }
                }
                
                // Check 3: Specific unavailable dates (e.g., vacation, sick days)
                if (provider.unavailable_dates && provider.unavailable_dates.includes(dateStr)) {
                    providerAvailability[provider.provider_id] = 'unavailable';
                    return;
                }
                
                // Provider is available
                providerAvailability[provider.provider_id] = 'available';
            });
        }

        function getAppointmentsForDateAndProvider(date, providerId) {
            const dateStr = formatDate(date);
            return appointments.filter(apt => 
                apt.date.startsWith(dateStr) && 
                apt.provider_id === providerId &&
                apt.status !== 'cancelled'     // Don't show cancelled appointments on provider calendar
            );
        }

        function findAppointmentAtTime(providerApts, timeSlot) {
            return providerApts.find(apt => apt.time.startsWith(timeSlot));
        }

        function renderCalendar() {
            const dateStr = formatDate(currentDate);
            console.log('üîç Rendering calendar for date:', dateStr);
            console.log('üìÖ Total appointments:', appointments.length);
            
            // Filter appointments for the selected date
            const dayAppointments = appointments.filter(apt => apt.date.startsWith(dateStr));
            console.log('‚úÖ Appointments for', dateStr, ':', dayAppointments.length, dayAppointments);
            
            // ALWAYS show ALL providers, regardless of whether they have appointments
            const displayProviders = providers.sort((a, b) => a.name.localeCompare(b.name));

            // Providers header (outside table)
            let html = `<div style="display: flex; margin-bottom: 0;">
                <div style="width: 80px; text-align: center; font-weight: 700; font-size: 18px; padding: 15px; background: #5a67d8; color: white; border-radius: 8px 0 0 0;"></div>
                <div style="flex: 1; text-align: center; font-weight: 700; font-size: 18px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0 8px 0 0;">Providers</div>
            </div>`;
            
            html += '<div class="calendar-grid">';
            
            // Header row with provider names
            html += '<div class="calendar-header">';
            html += '<div class="time-label-header">Time</div>';
            displayProviders.forEach(provider => {
                const isUnavailable = providerAvailability[provider.provider_id] === 'unavailable';
                const headerClass = isUnavailable ? 'provider-header unavailable' : 'provider-header';
                const badge = isUnavailable ? '<span class="provider-unavailable-badge">UNAVAILABLE</span>' : '';
                
                // Build provider tooltip - handle both specialties array and single specialty
                let specialtiesList = '';
                if (provider.specialties && provider.specialties.length > 0) {
                    specialtiesList = provider.specialties.map(s => `<span class="provider-specialty-badge">${s}</span>`).join('');
                } else if (provider.specialty) {
                    specialtiesList = `<span class="provider-specialty-badge">${provider.specialty}</span>`;
                } else {
                    specialtiesList = '<span style="color: #999; font-size: 12px;">Not specified</span>';
                }
                
                const certsList = provider.certifications && provider.certifications.length > 0
                    ? `<ul class="provider-cert-list">${provider.certifications.map(c => `<li>${c}</li>`).join('')}</ul>`
                    : '<span style="color: #999; font-size: 12px;">None listed</span>';
                
                const availableDays = provider.available_days && provider.available_days.length > 0
                    ? provider.available_days.join(', ')
                    : 'Not specified';
                
                const workingHours = `${provider.working_hours_start || '08:00'} - ${provider.working_hours_end || '17:00'}`;
                
                const capacity = 'WIP';  // Patient load tracking - Work In Progress
                
                const statusColor = isUnavailable ? '#dc3545' : '#4CAF50';
                const statusText = isUnavailable ? 'Unavailable' : 'Available';
                
                const tooltip = `
                    <div class="provider-tooltip">
                        <div class="provider-tooltip-title">${provider.name} PT</div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Experience</div>
                            <div class="provider-tooltip-value">
                                üéì ${provider.years_experience || 'N/A'} years ‚Ä¢ ${provider.experience_level || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Specialties</div>
                            <div class="provider-tooltip-specialties">${specialtiesList}</div>
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Certifications</div>
                            ${certsList}
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Location</div>
                            <div class="provider-tooltip-value">üìç ${provider.primary_location || 'N/A'} (${provider.zip || 'N/A'})</div>
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Working Hours</div>
                            <div class="provider-tooltip-value">üïê ${workingHours}</div>
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Available Days</div>
                            <div class="provider-tooltip-value">üìÖ ${availableDays}</div>
                        </div>
                        
                        ${provider.available_slots && provider.available_slots.length > 0 ? `
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Available Time Slots Today</div>
                            <div class="provider-tooltip-value">
                                üïê ${provider.available_slots.filter(s => s.available).map(s => s.time).join(', ') || 'None'}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Patient Load</div>
                            <div class="provider-tooltip-value">üë• ${capacity}</div>
                        </div>
                        
                        <div class="provider-tooltip-section">
                            <div class="provider-tooltip-label">Status</div>
                            <div class="provider-tooltip-value" style="color: ${statusColor}; font-weight: 600;">‚óè ${statusText}</div>
                        </div>
                    </div>
                `;
                
                // Add quick action button for available providers
                const actionButton = !isUnavailable ? `
                    <div class="provider-actions">
                        <button class="mark-unavailable-btn" onclick="markProviderUnavailable('${provider.provider_id}', '${provider.name}')" title="Mark provider as unavailable for today">
                            üö´ Mark Unavailable
                        </button>
                    </div>
                ` : '';
                
                html += `
                    <div class="${headerClass}">
                        ${provider.name} PT ${badge}
                        ${actionButton}
                        <div class="provider-specialty">${provider.specialty}</div>
                        ${tooltip}
                    </div>
                `;
            });
            html += '</div>';

            // Time slot rows
            timeSlots.forEach(timeSlot => {
                html += '<div class="calendar-row">';
                html += `<div class="time-label">${formatTime(timeSlot)}</div>`;
                
                displayProviders.forEach(provider => {
                    const providerApts = getAppointmentsForDateAndProvider(currentDate, provider.provider_id);
                    const appointment = findAppointmentAtTime(providerApts, timeSlot);
                    const isProviderUnavailable = providerAvailability[provider.provider_id] === 'unavailable';
                    
                    html += '<div class="appointment-cell">';
                    
                    if (appointment) {
                        const patient = patients[appointment.patient_id];
                        
                        if (!patient) {
                            console.warn('Patient not found:', appointment.patient_id);
                        }
                        
                        const patientName = patient ? patient.name : appointment.patient_id;
                        const patientCondition = patient ? (patient.condition || 'Physical Therapy') : 'Unknown';
                        const patientPhone = patient ? (patient.phone || 'N/A') : 'N/A';
                        const patientEmail = patient ? (patient.email || 'N/A') : 'N/A';
                        const patientInsurance = patient ? (patient.insurance_provider || 'N/A') : 'N/A';
                        const patientLocation = patient ? (patient.preferred_location || 'N/A') : 'N/A';
                        const patientZip = patient ? (patient.zip || 'N/A') : 'N/A';
                        const patientMaxDistance = patient ? (patient.max_distance_miles || 'N/A') : 'N/A';
                        const patientGenderPref = patient ? (patient.gender_preference || 'No preference') : 'N/A';
                        const patientPreferredDays = patient ? (patient.preferred_days || 'Any day') : 'N/A';
                        
                        // Get provider details for scoring explanation
                        const appointmentProvider = providers.find(p => p.provider_id === appointment.provider_id);
                        const providerZip = appointmentProvider ? (appointmentProvider.zip || 'N/A') : 'N/A';
                        const providerSpecialty = appointmentProvider ? (appointmentProvider.specialty || 'N/A') : 'N/A';
                        
                        // Calculate distance explanation
                        let distanceInfo = 'N/A';
                        if (patientZip !== 'N/A' && providerZip !== 'N/A' && patientZip !== providerZip) {
                            distanceInfo = `üìç Patient: ${patientZip} ‚Üí Provider: ${providerZip}`;
                            if (patientMaxDistance !== 'N/A') {
                                distanceInfo += ` (Max: ${patientMaxDistance} mi)`;
                            }
                        } else if (patientZip === providerZip) {
                            distanceInfo = `‚úÖ Same zip code (${patientZip})`;
                        }
                        
                        // AI Matching explanation - show whenever reasoning exists
                        let scoringExplanation = '';
                        // Use stored match data from appointment
                        const matchQuality = appointment.match_quality || null;
                        const reasoning = appointment.reasoning || null;
                        
                        // Show LLM reasoning (agentic approach) if available
                        if (reasoning) {
                            const qualityBadge = matchQuality ? (() => {
                                const qualityColor = {
                                    'EXCELLENT': '#2e7d32',
                                    'GOOD': '#1976d2',
                                    'ACCEPTABLE': '#f57c00',
                                    'POOR': '#c62828'
                                }[matchQuality] || '#666';
                                return `<span style="background:${qualityColor}; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${matchQuality}</span>`;
                            })() : '';
                            
                            scoringExplanation = `
                                <div style="margin-top:12px; padding-top:12px; border-top:2px solid #e0e0e0;">
                                    <div style="font-weight:700; color:#667eea; margin-bottom:8px;">
                                        ü§ñ AI Matching Analysis
                                        ${qualityBadge}
                                    </div>
                                    <div style="font-size:11px; line-height:1.6; color:#555; font-style:italic; white-space: pre-line;">
                                        üí≠ ${reasoning.replace(/Tier 1:/g, 'Tier 1 (Must-Have):').replace(/Tier 2:/g, '\nTier 2 (Preferences):')}
                                    </div>
                                </div>
                            `;
                        } else {
                            // Fallback: show match factors if reasoning not available
                            const factors = appointment.match_factors || {};
                            if (Object.keys(factors).length > 0) {
                                const tier1Factors = [];
                                const tier2Factors = [];
                                const legacyFactors = [];
                                
                                // Tier 1: Must-Have Criteria
                                if (factors.tier1_specialty_match !== undefined) {
                                    const icon = factors.tier1_specialty_match === true ? '‚úÖ' : '‚ùå';
                                    tier1Factors.push(`${icon} Specialty: ${patientCondition} ‚Üí ${providerSpecialty}`);
                                } else if (factors.specialty_match !== undefined) {
                                    // Legacy format
                                    const icon = factors.specialty_match === true || factors.specialty_match > 0 ? '‚úÖ' : '‚ö†Ô∏è';
                                    legacyFactors.push(`${icon} Specialty: ${patientCondition} ‚Üí ${providerSpecialty}`);
                                }
                                
                                if (factors.tier1_availability !== undefined) {
                                    const icon = factors.tier1_availability === true ? '‚úÖ' : '‚ùå';
                                    tier1Factors.push(`${icon} Availability`);
                                }
                                
                                if (factors.tier1_capacity !== undefined) {
                                    const icon = factors.tier1_capacity === true ? '‚úÖ' : '‚ùå';
                                    tier1Factors.push(`${icon} Capacity`);
                                }
                                
                                // Tier 2: Preference-Based Criteria
                                if (factors.tier2_gender_preference_met !== undefined) {
                                    const icon = factors.tier2_gender_preference_met === true ? '‚úÖ' : (patientGenderPref === 'any' ? '‚ûñ' : '‚ùå');
                                    tier2Factors.push(`${icon} Gender Preference: ${patientGenderPref}`);
                                } else if (factors.gender_preference_met !== undefined) {
                                    const icon = factors.gender_preference_met === true ? '‚úÖ' : (patientGenderPref === 'any' ? '‚ûñ' : '‚ùå');
                                    legacyFactors.push(`${icon} Gender Preference: ${patientGenderPref}`);
                                } else if (factors.gender_preference !== undefined) {
                                    // Legacy format
                                    const icon = factors.gender_preference > 0 ? '‚úÖ' : (patientGenderPref === 'any' ? '‚ûñ' : '‚ùå');
                                    legacyFactors.push(`${icon} Gender Preference: ${patientGenderPref}`);
                                }
                                
                                if (factors.tier2_location_match !== undefined) {
                                    const icon = factors.tier2_location_match === true ? '‚úÖ' : 'üìç';
                                    tier2Factors.push(`${icon} Location: ${distanceInfo}`);
                                } else if (factors.location_match !== undefined) {
                                    const icon = factors.location_match === true ? '‚úÖ' : 'üìç';
                                    legacyFactors.push(`${icon} Location: ${distanceInfo}`);
                                } else if (factors.proximity_same_zip !== undefined) {
                                    // Legacy format
                                    const icon = factors.proximity_same_zip > 0 ? '‚úÖ' : 'üìç';
                                    legacyFactors.push(`${icon} Distance: ${distanceInfo}`);
                                }
                                
                                if (factors.tier2_day_preference_met !== undefined) {
                                    const icon = factors.tier2_day_preference_met === true ? '‚úÖ' : '‚ùå';
                                    tier2Factors.push(`${icon} Day Preference: ${patientPreferredDays}`);
                                }
                                
                                if (factors.tier2_continuity !== undefined) {
                                    const icon = factors.tier2_continuity === true ? '‚úÖ' : '‚ûñ';
                                    tier2Factors.push(`${icon} Continuity with prior provider`);
                                }
                                
                                if (tier1Factors.length > 0 || tier2Factors.length > 0 || legacyFactors.length > 0) {
                                    // Infer match quality from score if not present
                                    let inferredQuality = matchQuality;
                                    if (!inferredQuality && appointment.match_score !== undefined) {
                                        const score = appointment.match_score;
                                        if (score >= 90) inferredQuality = 'EXCELLENT';
                                        else if (score >= 75) inferredQuality = 'GOOD';
                                        else if (score >= 60) inferredQuality = 'ACCEPTABLE';
                                        else inferredQuality = 'POOR';
                                    }
                                    
                                    const qualityBadge = inferredQuality ? (() => {
                                        const qualityColor = {
                                            'EXCELLENT': '#2e7d32',
                                            'GOOD': '#1976d2',
                                            'ACCEPTABLE': '#f57c00',
                                            'POOR': '#c62828'
                                        }[inferredQuality] || '#666';
                                        return `<span style="background:${qualityColor}; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${inferredQuality}</span>`;
                                    })() : '';
                                    
                                    // Build sections HTML
                                    let sectionsHTML = '';
                                    
                                    // Tier 1: Must-Have Criteria
                                    if (tier1Factors.length > 0) {
                                        sectionsHTML += `
                                            <div style="margin-bottom:10px;">
                                                <div style="font-weight:600; color:#c62828; font-size:11px; margin-bottom:4px;">
                                                    üî¥ Tier 1: Must-Have Criteria
                                                </div>
                                                <div style="font-size:10px; line-height:1.7; color:#555; margin-left:12px;">
                                                    ${tier1Factors.map(f => `<div style="margin:2px 0;">${f}</div>`).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // Tier 2: Preference-Based Criteria
                                    if (tier2Factors.length > 0) {
                                        sectionsHTML += `
                                            <div style="margin-bottom:10px;">
                                                <div style="font-weight:600; color:#1976d2; font-size:11px; margin-bottom:4px;">
                                                    üîµ Tier 2: Preference-Based Criteria
                                                </div>
                                                <div style="font-size:10px; line-height:1.7; color:#555; margin-left:12px;">
                                                    ${tier2Factors.map(f => `<div style="margin:2px 0;">${f}</div>`).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    // Legacy factors (if no tier-based factors)
                                    if (legacyFactors.length > 0 && tier1Factors.length === 0 && tier2Factors.length === 0) {
                                        sectionsHTML += `
                                            <div style="font-size:10px; line-height:1.7; color:#555;">
                                                ${legacyFactors.map(f => `<div style="margin:2px 0;">${f}</div>`).join('')}
                                            </div>
                                        `;
                                    }
                                    
                                    scoringExplanation = `
                                        <div style="margin-top:12px; padding-top:12px; border-top:2px solid #e0e0e0;">
                                            <div style="font-weight:700; color:#667eea; margin-bottom:8px;">
                                                ü§ñ AI Matching Analysis
                                                ${qualityBadge}
                                            </div>
                                            ${sectionsHTML}
                                        </div>
                                    `;
                                }
                            }
                        }
                        
                        const statusEmoji = {
                            'scheduled': 'üìÖ',
                            'completed': '‚úÖ',
                            'cancelled': '‚ùå',
                            'pending_review': '‚ö†Ô∏è',
                            'needs_attention': '‚ö†Ô∏è',
                            'pending_confirmation': 'üì≤',
                            'confirmed': '‚úÖ',
                            'reassigned': 'üîÑ'
                        }[appointment.status] || '‚ùì';
                        
                        // Check if appointment needs attention (HOD/manual review)
                        const needsAttention = appointment.needs_manual_review || 
                                              appointment.status === 'pending_review' ||
                                              appointment.status === 'needs_review' ||
                                              appointment.status === 'needs_attention' ||
                                              appointment.confirmation_status === 'needs_review' ||
                                              appointment.requires_review;
                        
                        // Determine visual class based on confirmation status
                        let statusClass = '';
                        let statusBadge = '';
                        
                        if (needsAttention) {
                            // Orange/Amber - HOD Manual Review Required
                            statusClass = 'needs-attention hod-review';
                            statusBadge = '<span class="attention-badge hod-badge">‚ö†Ô∏è HOD REVIEW</span>';
                        } else if (appointment.status === 'rescheduled' || appointment.reassigned) {
                            // Orange - Rescheduled, needs patient confirmation
                            statusClass = 'rescheduled';
                            statusBadge = '<span class="status-badge rescheduled">üì≤ PENDING CONFIRMATION</span>';
                        } else if (appointment.status === 'confirmed' || appointment.confirmation_status === 'confirmed') {
                            // Green - Confirmed by patient
                            statusClass = 'confirmed';
                            statusBadge = '<span class="status-badge confirmed">‚úÖ CONFIRMED</span>';
                        } else if (appointment.status === 'pending_confirmation' || appointment.confirmation_status === 'pending') {
                            // Light blue/yellow - Pending confirmation
                            statusClass = 'pending_confirmation';
                            statusBadge = '<span class="status-badge pending">üì≤ PENDING</span>';
                        }
                        
                        html += `
                            <div class="appointment-block ${appointment.status} ${statusClass}">
                                ${statusBadge}
                                <div class="appointment-time">${statusEmoji} ${formatTime(appointment.time)}</div>
                                <div class="appointment-patient">${patientName}</div>
                                <div class="appointment-condition">üìã ${patientCondition}</div>
                                <span class="status-badge ${appointment.status}">${appointment.status.toUpperCase()}</span>
                                
                                <button class="cancel-appointment-btn" onclick="cancelAppointment('${appointment.appointment_id}', '${patientName}', '${provider.name}', '${formatTime(appointment.time)}'); event.stopPropagation();" title="Cancel this appointment">
                                    √ó
                                </button>
                                
                                <div class="tooltip">
                                    <div class="tooltip-header">üë§ Patient Details</div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Name:</span>
                                        <span class="tooltip-value">${patientName}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Patient ID:</span>
                                        <span class="tooltip-value">${appointment.patient_id}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Condition:</span>
                                        <span class="tooltip-value">${patientCondition}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Phone:</span>
                                        <span class="tooltip-value">${patientPhone}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Email:</span>
                                        <span class="tooltip-value">${patientEmail}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Insurance:</span>
                                        <span class="tooltip-value">${patientInsurance}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Zip Code:</span>
                                        <span class="tooltip-value">${patientZip}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Max Distance:</span>
                                        <span class="tooltip-value">${patientMaxDistance} ${patientMaxDistance !== 'N/A' ? 'miles' : ''}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Location Pref:</span>
                                        <span class="tooltip-value">${patientLocation}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Gender Pref:</span>
                                        <span class="tooltip-value">${patientGenderPref}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Day Preference:</span>
                                        <span class="tooltip-value">${patientPreferredDays}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Appointment ID:</span>
                                        <span class="tooltip-value">${appointment.appointment_id}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-label">Confirmation:</span>
                                        <span class="tooltip-value">${appointment.confirmation_number || 'N/A'}</span>
                                    </div>
                                    ${scoringExplanation}
                                </div>
                            </div>
                        `;
                    } else if (isProviderUnavailable) {
                        // Provider is unavailable for this time slot
                        html += '<div class="unavailable-slot">üî¥ UNAVAILABLE</div>';
                    } else {
                        // Empty slot - provider is available
                        html += '<div class="empty-slot">‚Äî</div>';
                    }
                    
                    html += '</div>';
                });
                
                html += '</div>';
            });

            html += '</div>';
            document.getElementById('calendar-content').innerHTML = html;
            
            // Check for appointments needing attention
            const attentionCount = dayAppointments.filter(apt => 
                apt.needs_manual_review || 
                apt.status === 'pending_review' || 
                apt.status === 'needs_attention' ||
                apt.requires_review
            ).length;
            
            const banner = document.getElementById('attention-banner');
            const message = document.getElementById('attention-message');
            
            if (attentionCount > 0) {
                banner.style.display = 'block';
                message.textContent = `${attentionCount} appointment${attentionCount > 1 ? 's' : ''} require${attentionCount === 1 ? 's' : ''} manual review (marked with ‚ö†Ô∏è)`;
            } else {
                banner.style.display = 'none';
            }
        }

        async function markProviderUnavailable(providerId, providerName) {
            // Show modal instead of alert
            showUnavailableModal(providerId, providerName);
        }
        
        async function updateProviderStatus(providerId, durationType, startDate, endDate, reason) {
            // Update provider status in the local data and on server
            const baseUrl = getBaseUrl();
            
            // Find the provider in our local data
            const provider = providers.find(p => p.provider_id === providerId);
            if (!provider) {
                console.error('Provider not found:', providerId);
                return;
            }
            
            // Update provider status based on duration type
            if (durationType === 'left_organization') {
                provider.status = 'left_organization';
                provider.unavailable_dates = []; // Clear specific dates since permanently unavailable
            } else {
                provider.status = 'active'; // Keep active but add unavailable dates
                
                // Initialize unavailable_dates if not present
                if (!provider.unavailable_dates) {
                    provider.unavailable_dates = [];
                }
                
                // Generate date range and add to unavailable dates
                const start = new Date(startDate);
                const end = new Date(endDate || startDate);
                
                const current = new Date(start);
                while (current <= end) {
                    const dateStr = current.toISOString().split('T')[0]; // YYYY-MM-DD format
                    if (!provider.unavailable_dates.includes(dateStr)) {
                        provider.unavailable_dates.push(dateStr);
                    }
                    current.setDate(current.getDate() + 1);
                }
            }
            
            // Update the provider availability calculation
            calculateProviderAvailability();
        }
        
        async function confirmMarkUnavailable(providerId, providerName) {
            // Get form values
            const reason = document.getElementById('unavailable-reason').value;
            const durationType = document.querySelector('input[name="duration-type"]:checked').value;
            
            let startDate = formatDate(currentDate);
            let endDate = startDate;
            let permanent = false;
            
            // Calculate end date based on duration type
            const current = new Date(currentDate);
            switch(durationType) {
                case 'today':
                    endDate = startDate;
                    break;
                case 'tomorrow':
                    endDate = formatDate(new Date(current.getTime() + 86400000));
                    break;
                case '3days':
                    endDate = formatDate(new Date(current.getTime() + 2*86400000));
                    break;
                case 'custom':
                    startDate = document.getElementById('custom-start-date').value;
                    endDate = document.getElementById('custom-end-date').value;
                    break;
                case 'left_organization':
                    // For providers who left, use a 2-month date range to capture all future appointments
                    permanent = true;
                    const twoMonthsFromNow = new Date(current);
                    twoMonthsFromNow.setMonth(twoMonthsFromNow.getMonth() + 2);
                    endDate = formatDate(twoMonthsFromNow);
                    break;
            }
            
            // Close modal
            document.getElementById('unavailable-modal').style.display = 'none';
            
            // Show loading state
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'position:fixed; top:20px; right:20px; background:#667eea; color:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:999999; max-width:400px;';
            statusDiv.innerHTML = `
                <div style="font-size:16px; font-weight:600; margin-bottom:10px;">üîÑ Processing...</div>
                <div style="font-size:14px;">Marking ${providerName} unavailable and reassigning patients...</div>
            `;
            document.body.appendChild(statusDiv);
            
            try {
                // First, update the provider status in the data
                await updateProviderStatus(providerId, durationType, startDate, endDate, reason);
                
                // Then trigger the workflow via the existing API
                const baseUrl = getBaseUrl();
                const requestBody = {
                        trigger_type: 'provider_unavailable',
                        provider_id: providerId,
                    reason: durationType === 'left_organization' ? 'left_organization' : reason,
                        start_date: startDate,
                        end_date: endDate
                };
                
                // Add metadata for permanent status
                if (permanent) {
                    requestBody.metadata = { permanent: true, left_organization: true };
                }
                
                const response = await fetch(`${baseUrl}/api/trigger-workflow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Store audit log data
                window.lastAuditLog = result;
                
                // Show audit banner
                const auditBanner = document.getElementById('audit-log-banner');
                const auditMessage = document.getElementById('audit-message');
                auditMessage.textContent = `${result.affected_appointments_count || 0} appointments reassigned from ${providerName}`;
                auditBanner.style.display = 'block';
                
                // Show success with method indicator
                const methodIcon = result.used_fallback ? 'üîÑ' : 'ü§ñ';
                const methodText = result.used_fallback ? 'Rule-based assignment' : 'AI-powered assignment';
                const methodColor = result.used_fallback ? '#f39c12' : '#667eea';
                
                statusDiv.innerHTML = `
                    <div style="font-size:16px; font-weight:600; margin-bottom:10px;">‚úÖ Success!</div>
                    <div style="font-size:14px;">${providerName} marked unavailable</div>
                    <div style="font-size:12px; margin-top:8px; padding:8px; background:${methodColor}22; border-radius:6px; border-left:3px solid ${methodColor};">
                        ${methodIcon} <strong>${methodText}</strong>
                    </div>
                    <div style="font-size:13px; margin-top:8px; opacity:0.9;">
                        ‚Ä¢ Patients reassigned: ${result.affected_appointments_count || 0}<br>
                        ‚Ä¢ Emails sent: ${result.emails_sent || 0}<br>
                        ${permanent ? '‚Ä¢ Status: Permanently unavailable<br>' : ''}
                        ‚Ä¢ <span style="text-decoration:underline; cursor:pointer;" onclick="showAuditLog()">View audit log ‚Üí</span>
                    </div>
                `;
                
                // Reload calendar after 2 seconds
                setTimeout(() => {
                    statusDiv.remove();
                    loadData(); // Reload all data including updated provider status
                }, 3000);
                
            } catch (error) {
                console.error('Error marking provider unavailable:', error);
                statusDiv.innerHTML = `
                    <div style="font-size:16px; font-weight:600; margin-bottom:10px; color:#ff6b6b;">‚ùå Error</div>
                    <div style="font-size:14px;">Could not process request. Please use the chat UI instead.</div>
                    <div style="font-size:12px; margin-top:8px; opacity:0.8;">Error: ${error.message}</div>
                `;
                setTimeout(() => statusDiv.remove(), 4000);
            }
        }
        
        function showUnavailableModal(providerId, providerName) {
            // Store for later use
            window.selectedProviderId = providerId;
            window.selectedProviderName = providerName;
            
            // Set provider name in modal
            document.getElementById('modal-provider-name').textContent = providerName;
            
            // Set date labels
            const today = new Date(currentDate);
            const tomorrow = new Date(today.getTime() + 86400000);
            const dayAfter = new Date(today.getTime() + 2*86400000);
            
            document.getElementById('today-label').textContent = formatDateDisplay(today);
            document.getElementById('tomorrow-label').textContent = `${formatDateDisplay(today)} - ${formatDateDisplay(tomorrow)}`;
            document.getElementById('3days-label').textContent = `${formatDateDisplay(today)} - ${formatDateDisplay(dayAfter)}`;
            
            // Set custom date defaults
            document.getElementById('custom-start-date').value = formatDate(today);
            document.getElementById('custom-end-date').value = formatDate(today);
            
            // Reset to "Today only" as default
            document.querySelectorAll('input[name="duration-type"]').forEach(r => {
                r.checked = (r.value === 'today');
            });
            document.getElementById('custom-date-range').style.display = 'none';
            
            // Show modal
            document.getElementById('unavailable-modal').style.display = 'flex';
            
            // Highlight the default selected option (Today only)
            setTimeout(() => {
                document.querySelectorAll('input[name="duration-type"]').forEach(r => {
                    r.parentElement.style.borderColor = r.checked ? '#3498db' : '#ecf0f1';
                    r.parentElement.style.background = r.checked ? '#ebf5fb' : 'white';
                });
            }, 10);
            
            // Add radio button change listeners
            document.querySelectorAll('input[name="duration-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const customRange = document.getElementById('custom-date-range');
                    customRange.style.display = this.value === 'custom' ? 'block' : 'none';
                    
                    // Highlight selected option
                    document.querySelectorAll('input[name="duration-type"]').forEach(r => {
                        r.parentElement.style.borderColor = r === this && r.checked ? '#3498db' : '#ecf0f1';
                        r.parentElement.style.background = r === this && r.checked ? '#ebf5fb' : 'white';
                    });
                });
            });
        }
        
        function hideUnavailableModal() {
            document.getElementById('unavailable-modal').style.display = 'none';
        }
        
        function formatDateDisplay(date) {
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        function showAuditLog() {
            const modal = document.getElementById('audit-modal');
            const content = document.getElementById('audit-log-content');
            
            if (!window.lastAuditLog) {
                content.innerHTML = '<p>No audit log available.</p>';
                modal.classList.add('show');
                return;
            }
            
            const log = window.lastAuditLog;
            
            // Build audit log HTML
            let html = `
                <div class="audit-section">
                    <div class="audit-section-title">üìä Summary</div>
                    <div class="audit-item">
                        <span class="audit-label">Provider Unavailable:</span>
                        <span class="audit-value">${log.provider_id}</span>
                    </div>
                    <div class="audit-item">
                        <span class="audit-label">Date:</span>
                        <span class="audit-value">${formatDate(currentDate)}</span>
                    </div>
                    <div class="audit-item">
                        <span class="audit-label">Affected Appointments:</span>
                        <span class="audit-value">${log.affected_appointments_count}</span>
                    </div>
                    <div class="audit-item">
                        <span class="audit-label">Emails Sent:</span>
                        <span class="audit-value">${log.emails_sent}</span>
                    </div>
                    <div class="audit-item">
                        <span class="audit-label">Waitlist:</span>
                        <span class="audit-value">${log.waitlist_count}</span>
                    </div>
                </div>
            `;
            
            // Add assignment details
            if (log.assignments && log.assignments.length > 0) {
                html += '<div class="audit-section"><div class="audit-section-title">‚úÖ Reassignments</div>';
                
                log.assignments.forEach((assignment, idx) => {
                    const patient = window.patientsData?.find(p => p.patient_id === assignment.patient_id);
                    // Fix: API returns 'assigned_to', not 'new_provider_id'
                    const provider = window.providersData?.find(p => p.provider_id === (assignment.assigned_to || assignment.new_provider_id));
                    
                    html += `
                        <div class="audit-item">
                            <strong>${idx + 1}. ${patient?.name || assignment.patient_name || assignment.patient_id}</strong>
                            <div style="margin-left:20px; margin-top:6px; font-size:12px; color:#666;">
                                <div>üìã Condition: ${patient?.condition || 'N/A'}</div>
                                <div>üë®‚Äç‚öïÔ∏è Assigned to: ${provider?.name || assignment.assigned_to_name || assignment.assigned_to}</div>
                                <div>üè• Specialty: ${provider?.specialty || 'N/A'}</div>
                                <div>üìç Location: ${provider?.primary_location || 'N/A'}</div>
                                ${assignment.match_quality ? `<div>ü§ñ Match Quality: <strong>${assignment.match_quality}</strong></div>` : ''}
                            </div>
                            ${getScoringExplanation(patient, provider, assignment)}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Add waitlist details
            if (log.waitlist && log.waitlist.length > 0) {
                html += '<div class="audit-section"><div class="audit-section-title">‚è≥ Waitlist</div>';
                
                log.waitlist.forEach((entry, idx) => {
                    const patient = window.patientsData?.find(p => p.patient_id === entry.patient_id);
                    
                    html += `
                        <div class="audit-item">
                            <strong>${idx + 1}. ${patient?.name || entry.patient_id}</strong>
                            <div style="margin-left:20px; margin-top:6px; font-size:12px; color:#666;">
                                <div>üìã Condition: ${patient?.condition || 'N/A'}</div>
                                <div>üìù Reason: ${entry.reason || 'No suitable provider found'}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            content.innerHTML = html;
            modal.classList.add('show');
        }
        
        function hideAuditLog() {
            const modal = document.getElementById('audit-modal');
            modal.classList.remove('show');
        }
        
        function getScoringExplanation(patient, provider, assignment) {
            if (!patient || !provider) return '';
            
            let html = '';
            
            // Show LLM reasoning (agentic approach - primary)
            if (assignment && assignment.reasoning) {
                const matchQuality = assignment.match_quality || assignment.recommendation || null;
                const qualityBadge = matchQuality ? (() => {
                    const qualityColor = {
                        'EXCELLENT': '#2e7d32',
                        'GOOD': '#1976d2',
                        'ACCEPTABLE': '#f57c00',
                        'POOR': '#c62828'
                    }[matchQuality] || '#666';
                    return `<span style="background:${qualityColor}; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${matchQuality}</span>`;
                })() : '';
                
                html += `
                    <div class="scoring-details">
                        <div style="font-weight:600; margin-bottom:8px; color:#667eea;">
                            ü§ñ AI Matching Analysis
                            ${qualityBadge}
                        </div>
                        <div style="font-size:11px; line-height:1.6; color:#555; font-style:italic; white-space: pre-line;">
                            üí≠ ${assignment.reasoning.replace(/Tier 1:/g, 'Tier 1 (Must-Have):').replace(/Tier 2:/g, '\nTier 2 (Preferences):')}
                        </div>
                    </div>
                `;
            } else if (assignment && assignment.match_factors) {
                // Fallback: show match factors if reasoning not available
                const factors = assignment.match_factors;
                const factorItems = [];
                
                // Map factors to human-readable labels (boolean/descriptive, not points)
                if (factors.specialty_match === true || (factors.specialty_match && factors.specialty_match > 0)) {
                    factorItems.push(`‚úÖ Specialty Match: ${provider.specialty || 'N/A'}`);
                }
                
                if (factors.gender_preference_met === true || (factors.gender_preference && factors.gender_preference > 0)) {
                    factorItems.push(`‚úÖ Gender Preference Met`);
                }
                
                if (factors.location_match === true || (factors.proximity_same_zip && factors.proximity_same_zip > 0)) {
                    factorItems.push(`‚úÖ Location Match`);
                }
                
                if (factors.continuity === true || (factors.prior_provider_continuity && factors.prior_provider_continuity > 0)) {
                    factorItems.push(`‚úÖ Continuity: Prior provider relationship`);
                }
                
                if (factors.day_preference_met === true || (factors.preferred_day_match && factors.preferred_day_match > 0)) {
                    factorItems.push(`‚úÖ Day Preference Met`);
                }
                
                if (factors.experience_match === true || (factors.experience_match && factors.experience_match > 0)) {
                    factorItems.push(`‚úÖ Experience Match`);
                }
                
                if (factors.provider_capacity) {
                    const capacityText = factors.provider_capacity === 'low' ? 'Low capacity (good)' : 
                                       factors.provider_capacity === 'medium' ? 'Medium capacity' : 
                                       factors.provider_capacity === 'high' ? 'High capacity' : '';
                    if (capacityText) {
                        factorItems.push(`üìä Provider Capacity: ${capacityText}`);
                    }
                }
                
                if (factorItems.length > 0) {
                    const matchQuality = assignment.match_quality || assignment.recommendation || 'N/A';
                    const qualityColor = {
                        'EXCELLENT': '#2e7d32',
                        'GOOD': '#1976d2',
                        'ACCEPTABLE': '#f57c00',
                        'POOR': '#c62828'
                    }[matchQuality] || '#666';
                    
                    html += `
                        <div class="scoring-details">
                            <div style="font-weight:600; margin-bottom:6px; color:#667eea;">
                                ü§ñ AI Matching Analysis
                                ${matchQuality !== 'N/A' ? `<span style="background:${qualityColor}; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:6px;">${matchQuality}</span>` : ''}
                            </div>
                            ${factorItems.map(item => `<div class="scoring-factor">${item}</div>`).join('')}
                        </div>
                    `;
                }
            }
            
            // Also show matching factors (visual confirmation)
            let factors = [];
            
            // Specialty match
            if (patient.condition && provider.specialty) {
                // Check if provider specialty matches patient's needed specialty
                const patientCondition = patient.condition.toLowerCase();
                const providerSpecialty = provider.specialty.toLowerCase();
                
                // Define specialty matching rules
                const isOrthopedicMatch = (patientCondition.includes('knee') || 
                                         patientCondition.includes('back') || 
                                         patientCondition.includes('joint') || 
                                         patientCondition.includes('surgical') ||
                                         patientCondition.includes('orthopedic')) && 
                                        providerSpecialty.includes('orthopedic');
                
                const isNeuroMatch = (patientCondition.includes('stroke') || 
                                    patientCondition.includes('neuro') || 
                                    patientCondition.includes('brain')) && 
                                   providerSpecialty.includes('neuro');
                
                const isCardiacMatch = (patientCondition.includes('cardiac') || 
                                      patientCondition.includes('heart')) && 
                                     providerSpecialty.includes('cardiac');
                
                const match = isOrthopedicMatch || isNeuroMatch || isCardiacMatch;
                factors.push(`‚úì Specialty: ${provider.specialty} ${match ? '(‚úÖ Perfect Match)' : '(‚ö†Ô∏è Partial)'}`);
            }
            
            // Location/Distance
            if (patient.zip && provider.zip) {
                if (patient.zip === provider.zip) {
                    factors.push(`‚úì Distance: Same zip (${patient.zip}) ‚úÖ`);
                } else {
                    factors.push(`‚úì Distance: ${patient.zip} ‚Üí ${provider.zip}`);
                }
                if (patient.max_distance_miles) {
                    factors.push(`  (Patient max: ${patient.max_distance_miles} mi)`);
                }
            }
            
            // Insurance
            if (patient.insurance_provider && provider.accepted_insurance) {
                const accepted = provider.accepted_insurance.includes(patient.insurance_provider);
                factors.push(`‚úì Insurance: ${patient.insurance_provider} ${accepted ? '‚úÖ' : '‚ö†Ô∏è'}`);
            } else if (patient.insurance_provider) {
                factors.push(`‚úì Insurance: ${patient.insurance_provider}`);
            }
            
            // Gender preference
            if (patient.gender_preference && patient.gender_preference !== 'No preference') {
                const match = patient.gender_preference.toLowerCase() === provider.gender?.toLowerCase();
                factors.push(`‚úì Gender Pref: ${patient.gender_preference} ${match ? '‚úÖ' : '‚ö†Ô∏è'}`);
            }
            
            if (factors.length > 0) {
                html += `
                    <div class="scoring-details" style="margin-top:8px;">
                        <div style="font-weight:600; margin-bottom:6px; color:#666;">ü§ñ AI Matching Factors:</div>
                        ${factors.map(f => `<div class="scoring-factor">${f}</div>`).join('')}
                    </div>
                `;
            }
            
            return html;
        }
        
        function loadSchedule() {
            document.getElementById('calendar-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading schedule...
                </div>
            `;
            loadData();
        }

        // Initialize
        updateDateDisplay();
        loadSchedule();

        // Auto-refresh every 30 seconds
        setInterval(loadSchedule, 30000);

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                previousDay();
            } else if (e.key === 'ArrowRight') {
                nextDay();
            } else if (e.key === 't' || e.key === 'T') {
                goToToday();
            }
        });
        
        // ============================================================
        // Waitlist Modal Functions
        // ============================================================
        
        async function openWaitlistModal() {
            const modal = document.getElementById('waitlistModal');
            modal.classList.add('show');
            
            // Load waitlist data
            await loadWaitlistData();
        }
        
        function closeWaitlistModal(event) {
            if (!event || event.target.id === 'waitlistModal') {
                const modal = document.getElementById('waitlistModal');
                modal.classList.remove('show');
            }
        }
        
        // ============================================================
        // Cancel Appointment & Auto-Backfill
        // ============================================================
        
        async function cancelAppointment(appointmentId, patientName, providerName, time) {
            // Confirm cancellation
            const confirmed = confirm(
                `Cancel ${patientName}'s appointment?\n\n` +
                `Provider: ${providerName}\n` +
                `Time: ${time}\n\n` +
                `This will:\n` +
                `‚úÖ Add patient to waitlist\n` +
                `‚úÖ Free up the time slot\n` +
                `‚úÖ Auto-match with waitlist patients (if available)`
            );
            
            if (!confirmed) return;
            
            try {
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'cancel-loading';
                loadingDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10001;';
                loadingDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
                        <div>Cancelling appointment...</div>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                // Call API to cancel appointment
                const baseUrl = getBaseUrl();
                const response = await fetch(`${baseUrl}/api/appointments/${appointmentId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: 'Cancelled by receptionist',
                        add_to_waitlist: true,
                        trigger_backfill: true
                    })
                });
                
                const result = await response.json();
                
                // Remove loading
                document.body.removeChild(loadingDiv);
                
                if (result.success) {
                    // Show success message
                    let message = `‚úÖ Appointment cancelled!\n\n${patientName} added to waitlist.`;
                    
                    if (result.backfill_result && result.backfill_result.status === 'BACKFILLED') {
                        const backfilledPatient = result.backfill_result.patient_name || result.backfill_result.patient_id;
                        message += `\n\nüéâ SLOT AUTO-FILLED!\n${backfilledPatient} automatically booked into this slot.`;
                    } else {
                        message += `\n\n‚è≥ Slot is now available for backfill.`;
                    }
                    
                    alert(message);
                    
                    // Refresh calendar and waitlist
                    await loadAppointmentsData();
                    await loadWaitlistData();
                    renderCalendar();
                } else {
                    alert(`‚ùå Error: ${result.message || 'Failed to cancel appointment'}`);
                }
                
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert(`‚ùå Error cancelling appointment: ${error.message}`);
                
                // Remove loading if still present
                const loading = document.getElementById('cancel-loading');
                if (loading) document.body.removeChild(loading);
            }
        }
        
        async function loadWaitlistData() {
            try {
                const baseUrl = getBaseUrl();
                const [waitlistRes, slotsRes] = await Promise.all([
                    fetch(`${baseUrl}/api/waitlist`),
                    fetch(`${baseUrl}/api/freed-slots`)
                ]);
                
                const waitlist = await waitlistRes.json();
                const freedSlots = await slotsRes.json();
                
                displayWaitlistData(waitlist, freedSlots);
                updateWaitlistBadge(waitlist.length);
            } catch (error) {
                console.error('Error loading waitlist:', error);
                document.getElementById('waitlistContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Error loading waitlist data</div>
                    </div>
                `;
            }
        }
        
        function displayWaitlistData(waitlist, freedSlots) {
            const content = document.getElementById('waitlistContent');
            
            if (waitlist.length === 0 && freedSlots.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">All Clear!</div>
                        <div>No patients on waitlist and no available slots</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Group by priority
            const highPriority = waitlist.filter(w => w.priority === 'HIGH');
            const mediumPriority = waitlist.filter(w => w.priority === 'MEDIUM');
            const lowPriority = waitlist.filter(w => w.priority === 'LOW');
            
            // High Priority
            if (highPriority.length > 0) {
                html += `
                    <div class="waitlist-section">
                        <div class="section-title priority-high">
                            üî¥ HIGH PRIORITY (${highPriority.length})
                        </div>
                        ${highPriority.map(w => renderWaitlistCard(w, 'high')).join('')}
                    </div>
                `;
            }
            
            // Medium Priority
            if (mediumPriority.length > 0) {
                html += `
                    <div class="waitlist-section">
                        <div class="section-title priority-medium">
                            üü° MEDIUM PRIORITY (${mediumPriority.length})
                        </div>
                        ${mediumPriority.map(w => renderWaitlistCard(w, 'medium')).join('')}
                    </div>
                `;
            }
            
            // Low Priority
            if (lowPriority.length > 0) {
                html += `
                    <div class="waitlist-section">
                        <div class="section-title priority-low">
                            ‚ö™ LOW PRIORITY (${lowPriority.length})
                        </div>
                        ${lowPriority.map(w => renderWaitlistCard(w, 'low')).join('')}
                    </div>
                `;
            }
            
            // Freed Slots
            if (freedSlots.length > 0) {
                html += `
                    <div class="waitlist-section">
                        <div class="section-title" style="color: #27ae60;">
                            üé∞ AVAILABLE SLOTS (${freedSlots.length})
                        </div>
                        ${freedSlots.map(s => renderFreedSlotCard(s)).join('')}
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }
        
        function renderWaitlistCard(entry, priorityClass) {
            const addedDate = new Date(entry.added_to_waitlist).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
            
            // Determine waitlist reason
            const reason = entry.waitlist_reason || entry.notes || 'No provider match found';
            let reasonIcon = '‚ö†Ô∏è';
            let reasonColor = '#f39c12';
            
            if (reason.includes('cancelled')) {
                reasonIcon = '‚ùå';
                reasonColor = '#e74c3c';
            } else if (reason.includes('declined')) {
                reasonIcon = 'üö´';
                reasonColor = '#e67e22';
            } else if (reason.includes('score')) {
                reasonIcon = 'üìä';
                reasonColor = '#3498db';
            }
            
            // Build availability info
            const availDays = entry.availability_windows?.days?.join(', ') || 'Any day';
            const availTimes = entry.availability_windows?.times?.join(', ') || 'Any time';
            
            // Determine recommended action
            let recommendedAction = '';
            const noShowRisk = entry.no_show_risk || 0;
            
            if (noShowRisk >= 0.6) {
                recommendedAction = `
                    <div style="background: #e8f8f5; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60; margin-top: 12px;">
                        <div style="font-weight: 600; color: #27ae60; margin-bottom: 6px;">üíº RECOMMENDED ACTION:</div>
                        <div style="font-size: 13px; color: #555;">
                            ü§ñ <strong>Auto-backfill enabled</strong><br>
                            System will automatically book patient when matching slot opens<br>
                            <span style="color: #27ae60;">‚úì No action needed - monitoring active</span>
                        </div>
                    </div>
                `;
            } else if (reason.includes('cancelled') || reason.includes('declined')) {
                recommendedAction = `
                    <div style="background: #fff3e0; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800; margin-top: 12px;">
                        <div style="font-weight: 600; color: #ff9800; margin-bottom: 6px;">üíº RECOMMENDED ACTION:</div>
                        <div style="font-size: 13px; color: #555;">
                            üìû <strong>Contact patient</strong> to offer alternative times/providers<br>
                            <span style="color: #7f8c8d;">‚è≥ Auto-backfill monitoring active</span>
                        </div>
                    </div>
                `;
            } else {
                recommendedAction = `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #95a5a6; margin-top: 12px;">
                        <div style="font-weight: 600; color: #7f8c8d; margin-bottom: 6px;">üíº RECOMMENDED ACTION:</div>
                        <div style="font-size: 13px; color: #555;">
                            ‚ö†Ô∏è <strong>Manual review required</strong><br>
                            No suitable automatic match - HOD should review
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="waitlist-card ${priorityClass}">
                    <div class="card-header">
                        <div>
                            <div class="patient-name">${entry.name || 'Unknown'}</div>
                            <div class="patient-id">${entry.patient_id}</div>
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #7f8c8d;">
                            Added: ${addedDate}
                        </div>
                    </div>
                    
                    <!-- Waitlist Reason -->
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 12px 0; border-left: 3px solid ${reasonColor};">
                        <div style="font-weight: 600; font-size: 13px; color: ${reasonColor}; margin-bottom: 4px;">
                            ${reasonIcon} WAITLIST REASON:
                        </div>
                        <div style="font-size: 13px; color: #555;">
                            ${reason}
                        </div>
                    </div>
                    
                    <!-- Patient Details -->
                    <div class="card-details">
                        <div class="detail-item">
                            <span class="detail-label">Condition:</span> ${entry.condition || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Specialty:</span> ${entry.requested_specialty || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location:</span> ${entry.requested_location || 'Any'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">No-show Risk:</span> 
                            <span style="color: ${noShowRisk >= 0.6 ? '#e74c3c' : '#95a5a6'}; font-weight: 600;">
                                ${entry.no_show_risk ? (entry.no_show_risk * 100).toFixed(0) + '%' : 'N/A'}
                                ${noShowRisk >= 0.6 ? ' (HIGH - Priority for backfill)' : ''}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Looking For -->
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 12px 0;">
                        <div style="font-weight: 600; font-size: 13px; color: #1976d2; margin-bottom: 6px;">
                            üéØ LOOKING FOR:
                        </div>
                        <div style="font-size: 12px; color: #555; line-height: 1.6;">
                            ‚Ä¢ <strong>Provider:</strong> ${entry.requested_specialty || 'Any specialist'}<br>
                            ‚Ä¢ <strong>Location:</strong> ${entry.requested_location || 'Any location'}<br>
                            ‚Ä¢ <strong>Days:</strong> ${availDays}<br>
                            ‚Ä¢ <strong>Times:</strong> ${availTimes}<br>
                            ‚Ä¢ <strong>Willing to move up:</strong> ${entry.willing_to_move_up ? '‚úÖ Yes' : '‚ùå No'}
                        </div>
                    </div>
                    
                    <!-- Recommended Action -->
                    ${recommendedAction}
                </div>
            `;
        }
        
        function renderFreedSlotCard(slot) {
            const slotDate = new Date(slot.date).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            
            return `
                <div class="freed-slot-card">
                    <div class="slot-header">
                        ${slot.provider_id} - ${slotDate} @ ${slot.time}
                    </div>
                    <div class="slot-details">
                        Specialty: ${slot.specialty} | Location: ${slot.location} | Duration: ${slot.duration_minutes} mins
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #7f8c8d;">
                        Freed: ${slot.reason_freed}
                    </div>
                </div>
            `;
        }
        
        function updateWaitlistBadge(count) {
            const badge = document.getElementById('waitlist-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }
        
        // Load waitlist count on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const baseUrl = getBaseUrl();
                const res = await fetch(`${baseUrl}/api/waitlist`);
                const waitlist = await res.json();
                updateWaitlistBadge(waitlist.length);
            } catch (error) {
                console.error('Error loading waitlist count:', error);
            }
        });
    </script>
    
    <!-- Waitlist Modal -->
    <div id="waitlistModal" class="modal-overlay" onclick="closeWaitlistModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">‚è≥ Waitlist & Available Slots</div>
                <button class="modal-close" onclick="closeWaitlistModal()">&times;</button>
            </div>
            <div class="modal-body" id="waitlistContent">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                    <div>Loading waitlist...</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
